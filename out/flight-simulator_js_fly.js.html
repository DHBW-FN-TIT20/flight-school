<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: flight-simulator/js/fly.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: flight-simulator/js/fly.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check

/** @type {number} */
let distancePerFly = 1.5;

/** @type {THREE.Vector3} */
const planeStartPoint = new THREE.Vector3(4, 0.85, 3);

/** @type {number} */
const distanceOfCameraFromPlane = 1.5;

/** @type {boolean} */
let checkForPlaneCollision = true;


/**
 * Initializes the flying controls
 */
async function initFlying() {

    camera.lookAt(planeStartPoint);

    // createCrosshair();

    // as further the mouse is right/left of the cross the more the plane is moving right/left
    // headingTo = { right: int, up: int } stores values from 0 to 100 
    // headingTo = { right: -80, up: 5 } would move the plane a bit up and strongly to the left

    // change cursor to crosshair
    document.body.style.cursor = "crosshair";

    window.addEventListener("mousemove", event => {
        headingTo.right = invertedControls ? (event.clientX - window.innerWidth / 2) / 2 : - (event.clientX - window.innerWidth / 2) / 2;
        headingTo.up = invertedControls ? (window.innerHeight / 2 - event.clientY) / 2 : - (window.innerHeight / 2 - event.clientY) / 2;
        document.body.style.cursor = "crosshair";
        if (headingTo.right > 100) { headingTo.right = 100; document.body.style.cursor = "e-resize"; }
        if (headingTo.right &lt; -100) { headingTo.right = -100; document.body.style.cursor = "w-resize"; }
        if (headingTo.up > 100) { headingTo.up = 100; document.body.style.cursor = "n-resize"; }
        if (headingTo.up &lt; -100) { headingTo.up = -100; document.body.style.cursor = "s-resize"; }
    });

    // add touch support for mobile devices
    window.addEventListener("touchmove", event => {
        headingTo.right = - (event.touches[0].clientX - window.innerWidth / 2) / 2;
        headingTo.up = - (window.innerHeight / 2 - event.touches[0].clientY) / 2;
        document.body.style.cursor = "crosshair";
        if (headingTo.right > 100) { headingTo.right = 100; document.body.style.cursor = "e-resize"; }
        if (headingTo.right &lt; -100) { headingTo.right = -100; document.body.style.cursor = "w-resize"; }
        if (headingTo.up > 100) { headingTo.up = 100; document.body.style.cursor = "n-resize"; }
        if (headingTo.up &lt; -100) { headingTo.up = -100; document.body.style.cursor = "s-resize"; }
    });

    await createModelPlane();

    camera.lookAt(sceneObjects.modelPlane.position);
}


/**
 * Moves the Plane and the Camera
 */
function handleFlying() {

    if (!sceneObjects.modelPlane) return;

    // get the planes lookAt vector by its quaternion
    let quaternion = sceneObjects.modelPlane.quaternion;
    let planeLookAt = new THREE.Vector3(0, 0, 1);
    planeLookAt.applyQuaternion(quaternion);
    planeLookAt.normalize();

    // manipulate the lookAt vector by the headingTo values
    planeLookAt = turnVectorAroundVerticalAxis(planeLookAt, degToRad(headingTo.right * - 0.01));
    planeLookAt = turnVectorAroundHorizontalAxis(planeLookAt, degToRad(headingTo.up * 0.03));
    planeLookAt.normalize();

    // set the new lookAt vector
    let newPointToLookAt = new THREE.Vector3(sceneObjects.modelPlane.position.x + planeLookAt.x, sceneObjects.modelPlane.position.y + planeLookAt.y, sceneObjects.modelPlane.position.z + planeLookAt.z);
    sceneObjects.modelPlane.lookAt(newPointToLookAt);

    // move the plane forward (always)
    let newPlanePosition = sceneObjects.modelPlane.position.clone();
    newPlanePosition.addScaledVector(planeLookAt, distancePerFly * deltaTime);

    // apply the new position
    sceneObjects.modelPlane.position.set(newPlanePosition.x, newPlanePosition.y, newPlanePosition.z);

    // move the camera behind the plane -lookAt
    camera.position.set(newPlanePosition.x, newPlanePosition.y, newPlanePosition.z);
    camera.position.addScaledVector(planeLookAt, -distanceOfCameraFromPlane);
    camera.lookAt(newPlanePosition);

    // tend the plane a little bit to the right/left depending on the headingTo.right value
    sceneObjects.modelPlane.rotateOnWorldAxis(planeLookAt, degToRad(headingTo.right * 0.4));

    if (!checkForPlaneCollision) return;

    // check for collision
    let planeCollided = false;
    let allMeshs = getAllMeshsFromNestedGroup(scene);
    for (let i = 0; i &lt; allMeshs.length; i++) {
        if (allMeshs[i] !== sceneObjects.modelPlane &amp;&amp; !meshIsChildOf(allMeshs[i], sceneObjects.modelPlane) &amp;&amp; allMeshs[i].name !== "" &amp;&amp; !getAllMeshsFromNestedGroup(sceneObjects.environment).includes(allMeshs[i])) {
            if (checkCollision(sceneObjects.modelPlane, allMeshs[i])) {
                console.log("collision with ", allMeshs[i]);
                planeCollided = true;
                break;
            }
        }
    }
    if (planeCollided) {
        distancePerFly = 0;

        // show the plane in red
        sceneObjects.modelPlane.traverse(function (child) {
            if (child.isMesh) {
                child.material.color.setHex(0xff0000);
            }
        });

        // timeout for 1 second
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

}


/**
 * Creates the plane model and adds it to the scene
 */
async function createModelPlane() {

    // load the plane model
    const modelPlane = await getMashFromBlenderModel("../low-poly_airplane.glb-low", "https://download1591.mediafire.com/1ukswzole2ag/2otcm1ju178d63g/basic_plane.glb");
    scene.add(modelPlane);

    /** @type { THREE.Mesh } */
    sceneObjects.modelPlane = modelPlane;

    // set the plane position
    sceneObjects.modelPlane.position.set(planeStartPoint.x, planeStartPoint.y, planeStartPoint.z);
    sceneObjects.modelPlane.scale.set(0.002, 0.003, 0.003);
    sceneObjects.modelPlane.lookAt(planeStartPoint.x, planeStartPoint.y, planeStartPoint.z - 1);
}


/**
 * Turns a vector around the vertical axis (for plane movement)
 * @param { THREE.Vector3 } vector
 * @param { number } angle 
 */
function turnVectorAroundVerticalAxis(vector, angle) {
    let newVector = new THREE.Vector3(vector.x, vector.y, vector.z);
    newVector.applyAxisAngle(new THREE.Vector3(0, 1, 0), angle);
    return newVector;
}


/**
 * Turns a vector around the horizontal axis (for plane movement)
 * @param {*} vector 
 * @param {*} angle 
 */
function turnVectorAroundHorizontalAxis(vector, angle) {

    let newVector = new THREE.Vector3(vector.x, vector.y + 0.5 * angle, vector.z);
    return newVector;

    // TODO: check if more complex calculation is needed

    // // get the horizontal vector
    // let horizontalVector = new THREE.Vector3(vector.x, 0, vector.z);
    // horizontalVector.normalize();

    // // get the vertical vector
    // let verticalVector = new THREE.Vector3(0, vector.y, 0);
    // verticalVector.normalize();

    // // get the cross product of the horizontal and vertical vector
    // let crossProduct = new THREE.Vector3();
    // crossProduct.crossVectors(horizontalVector, verticalVector);
    // crossProduct.normalize();

    // // rotate the vector around the cross product
    // let newVector = new THREE.Vector3(vector.x, vector.y, vector.z);
    // newVector.applyAxisAngle(crossProduct, angle);

    // return newVector;
}


/**
 * Checks if a mesh is a child of another mesh (recursive)
 * @param {THREE.Mesh&lt;THREE.BufferGeometry, THREE.Material | THREE.Material[]>} possibleChild
 * @param {THREE.Mesh} parent
 */
function meshIsChildOf(possibleChild, parent) {
    if (possibleChild.parent === parent) return true;
    if (possibleChild.parent === null) return false;
    // @ts-ignore
    return meshIsChildOf(possibleChild.parent, parent);
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#animate">animate</a></li><li><a href="global.html#checkCollision">checkCollision</a></li><li><a href="global.html#checkForPlaneCollision">checkForPlaneCollision</a></li><li><a href="global.html#checkIfPointIsInsideMesh">checkIfPointIsInsideMesh</a></li><li><a href="global.html#createCrosshair">createCrosshair</a></li><li><a href="global.html#createModelPlane">createModelPlane</a></li><li><a href="global.html#createPlayer">createPlayer</a></li><li><a href="global.html#degToRad">degToRad</a></li><li><a href="global.html#distanceOfCameraFromPlane">distanceOfCameraFromPlane</a></li><li><a href="global.html#distancePerFly">distancePerFly</a></li><li><a href="global.html#gameOver">gameOver</a></li><li><a href="global.html#getAllMeshsFromNestedGroup">getAllMeshsFromNestedGroup</a></li><li><a href="global.html#getCameraLookAt">getCameraLookAt</a></li><li><a href="global.html#getHeightOfMesh">getHeightOfMesh</a></li><li><a href="global.html#getMashFromBlenderModel">getMashFromBlenderModel</a></li><li><a href="global.html#getNewPosition">getNewPosition</a></li><li><a href="global.html#handleAnimateChairs">handleAnimateChairs</a></li><li><a href="global.html#handleAnimateClosets">handleAnimateClosets</a></li><li><a href="global.html#handleFlying">handleFlying</a></li><li><a href="global.html#handleInfoDiv">handleInfoDiv</a></li><li><a href="global.html#handlePlaneOutOfBounds">handlePlaneOutOfBounds</a></li><li><a href="global.html#handleScore">handleScore</a></li><li><a href="global.html#handleTime">handleTime</a></li><li><a href="global.html#handleWalking">handleWalking</a></li><li><a href="global.html#infoDiv">infoDiv</a></li><li><a href="global.html#infoStartTime">infoStartTime</a></li><li><a href="global.html#infoTable">infoTable</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initAdjustBlackboardHeight">initAdjustBlackboardHeight</a></li><li><a href="global.html#initDevControls">initDevControls</a></li><li><a href="global.html#initFlying">initFlying</a></li><li><a href="global.html#initInfoDiv">initInfoDiv</a></li><li><a href="global.html#initInteractions">initInteractions</a></li><li><a href="global.html#initMouseClickMove">initMouseClickMove</a></li><li><a href="global.html#initOceanAndSky">initOceanAndSky</a></li><li><a href="global.html#initOpenCloset">initOpenCloset</a></li><li><a href="global.html#initPutChairOnTable">initPutChairOnTable</a></li><li><a href="global.html#initStartScreen">initStartScreen</a></li><li><a href="global.html#initStats">initStats</a></li><li><a href="global.html#initSwitchLight">initSwitchLight</a></li><li><a href="global.html#initTriggerFlightSimulator">initTriggerFlightSimulator</a></li><li><a href="global.html#initWalk">initWalk</a></li><li><a href="global.html#meshIsChildOf">meshIsChildOf</a></li><li><a href="global.html#placeObjects">placeObjects</a></li><li><a href="global.html#placeObstaclesObjects">placeObstaclesObjects</a></li><li><a href="global.html#placeTorusObjects">placeTorusObjects</a></li><li><a href="global.html#planeStartPoint">planeStartPoint</a></li><li><a href="global.html#putStartScreenOnReady">putStartScreenOnReady</a></li><li><a href="global.html#removeCrosshair">removeCrosshair</a></li><li><a href="global.html#showBoundingBox">showBoundingBox</a></li><li><a href="global.html#startScene">startScene</a></li><li><a href="global.html#turnVectorAroundHorizontalAxis">turnVectorAroundHorizontalAxis</a></li><li><a href="global.html#turnVectorAroundVerticalAxis">turnVectorAroundVerticalAxis</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Sat Nov 12 2022 13:59:58 GMT+0100 (Mitteleuropäische Normalzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
